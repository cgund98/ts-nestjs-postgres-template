version: '3.8'

services:
  postgres:
    image: postgres:16
    container_name: nestjs-postgres-template-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: app
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - default

  localstack:
    image: localstack/localstack:latest
    container_name: nestjs-postgres-template-localstack
    ports:
      - "4566:4566"
      - "4510-4559:4510-4559"  # External services port range
    environment:
      - SERVICES=sns,sqs
      - DEBUG=1
      - PERSISTENCE=0
      - LAMBDA_EXECUTOR=local
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - default

  app:
    build:
      context: .
      dockerfile: resources/docker/app.Dockerfile
      target: production
    container_name: nestjs-postgres-template-app
    depends_on:
      postgres:
        condition: service_healthy
      localstack:
        condition: service_healthy
    ports:
      - "8000:8000"
    networks:
      - default
    environment:
      # Application
      - SERVICE_NAME=app
      - ENVIRONMENT=development
      - LOG_LEVEL=info
      - PORT=8000

      # Database
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DATABASE=app

      # Messaging
      - DEFAULT_EVENT_TOPIC_ARN=arn:aws:sns:us-east-1:000000000000:events-topic

      # AWS / LocalStack
      - AWS_REGION=us-east-1
      - AWS_ENDPOINT_URL=http://localstack:4566
      - USE_LOCALSTACK=true
    volumes:
      # Mount source code for development/testing
      - .:/app
      - /app/node_modules
    # Default command runs the API server
    # Override with: docker-compose run --rm app pnpm test
    # Or: docker-compose run --rm app pnpm exec vitest run tests/unit
    # Or: docker-compose run --rm app pnpm exec vitest run tests/integration
    command: ["node", "dist/entry/api/main.js"]

volumes:
  postgres_data:

networks:
  default:
    name: nestjs-postgres-template-network

